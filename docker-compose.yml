services:
  # PostgreSQL with pgvector extension
  pgvector:
    image: pgvector/pgvector:pg16
    container_name: llm-pgvector
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: codebase_rag
    ports:
      - "5432:5432"
    volumes:
      - pgvector_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Main application (CLI tools)
  app:
    build: .
    container_name: llm-fine-tuning
    volumes:
      # Mount source code for development
      - .:/app
      # Mount GCP credentials (use absolute path to avoid snap Docker path issues)
      - /home/miordache/.config/gcloud:/root/.config/gcloud:ro
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/root/.config/gcloud/application_default_credentials.json
      - GCP_PROJECT_ID=${GCP_PROJECT_ID:-}
      - PGHOST=pgvector
      - PGPORT=5432
      - PGDATABASE=codebase_rag
      - PGUSER=postgres
      - PGPASSWORD=postgres
    depends_on:
      pgvector:
        condition: service_healthy
    # Keep container running for interactive use
    stdin_open: true
    tty: true

  # Koda API Backend (Python/FastAPI)
  koda-api:
    build: .
    container_name: koda-api
    expose:
      - "8080"
    volumes:
      - .:/app
      # Mount GCP credentials (use absolute path to avoid snap Docker path issues)
      - /home/miordache/.config/gcloud:/root/.config/gcloud:ro
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/root/.config/gcloud/application_default_credentials.json
      - GCP_PROJECT_ID=${GCP_PROJECT_ID:-}
      - GCP_LOCATION=${GCP_LOCATION:-us-central1}
      - LLM_MODEL=${LLM_MODEL:-gemini-2.5-flash}
      - PGHOST=pgvector
      - PGPORT=5432
      - PGDATABASE=codebase_rag
      - PGUSER=postgres
      - PGPASSWORD=postgres
      - HOST=0.0.0.0
      - PORT=8080
    depends_on:
      pgvector:
        condition: service_healthy
    working_dir: /app/web
    command:
      [
        "python3",
        "-m",
        "uvicorn",
        "server:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8080",
      ]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Koda Web Frontend (React + TypeScript)
  koda:
    build: ./web-v2
    container_name: koda
    ports:
      - "8080:80"
    depends_on:
      koda-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  pgvector_data:
